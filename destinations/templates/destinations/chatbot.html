{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock %}

{% block content %}
<div class="chatbot-container">
    <div class="chatbot-header">
        <h1>üõï Tamil Nadu Tourist Guide</h1>
        <p>Ask me anything about tourist places in Tamil Nadu!</p>
    </div>
    
    <div class="chatbot-main">
        <div class="chatbot-sidebar">
            <div class="place-selector">
                <h3>üìç Select a Place</h3>
                <select id="place-selector" class="place-dropdown">
                    <option value="">General Questions</option>
                    {% for place in places %}
                    <option value="{{ place.id }}" {% if selected_place_id == place.id|stringformat:"s" %}selected{% endif %}>{{ place.name }} - {{ place.district }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="quick-questions">
                <h3>üí° Quick Questions</h3>
                <div class="quick-question" data-question="How to reach this place?">üöó How to reach?</div>
                <div class="quick-question" data-question="What is the best time to visit?">‚è∞ Best time to visit?</div>
                <div class="quick-question" data-question="What are the entry fees?">üí∞ Entry fees?</div>
                <div class="quick-question" data-question="What are the nearby attractions?">üèõÔ∏è Nearby attractions?</div>
                <div class="quick-question" data-question="Where can I stay nearby?">üè® Accommodation?</div>
            </div>
        </div>
        
        <div class="chatbot-chat">
            <div class="chat-messages" id="chat-messages">
                <div class="message bot-message">
                    <div class="message-content">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-text">
                            <p>Hello! I'm your Tamil Nadu tourist guide. I can help you with:</p>
                            <ul>
                                <li>Information about tourist places</li>
                                <li>How to reach destinations</li>
                                <li>Best time to visit</li>
                                <li>Entry fees and timings</li>
                                <li>Nearby attractions</li>
                                <li>Accommodation options</li>
                            </ul>
                            <p>Select a place from the sidebar or ask me anything about Tamil Nadu tourism!</p>
                        </div>
                    </div>
                    <div class="message-time">Just now</div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <input type="text" id="chat-input" placeholder="Ask me about tourist places..." maxlength="500">
                    <button id="send-button" class="send-button">
                        <span>Send</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                <div class="typing-indicator" id="typing-indicator" style="display: none;">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span>Guide is thinking...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.chatbot-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    min-height: 80vh;
    margin-top: 20px; /* Add space below navbar */
}

.chatbot-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    color: white;
}

.chatbot-header h1 {
    margin: 0 0 10px 0;
    font-size: 2.5rem;
    font-weight: 700;
}

.chatbot-header p {
    margin: 0;
    font-size: 1.1rem;
    opacity: 0.9;
}

.chatbot-main {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 20px;
    height: 600px;
}

.chatbot-sidebar {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.place-selector h3, .quick-questions h3 {
    margin: 0 0 15px 0;
    color: #333;
    font-size: 1.1rem;
    font-weight: 600;
}

.place-dropdown {
    width: 100%;
    padding: 12px;
    border: 2px solid #e1e5e9;
    border-radius: 10px;
    font-size: 14px;
    background: white;
    transition: border-color 0.3s ease;
}

.place-dropdown:focus {
    outline: none;
    border-color: #667eea;
}

.quick-questions {
    flex: 1;
}

.quick-question {
    padding: 12px 15px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    border: 1px solid transparent;
}

.quick-question:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.chatbot-chat {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.message {
    display: flex;
    flex-direction: column;
    max-width: 80%;
}

.user-message {
    align-self: flex-end;
}

.bot-message {
    align-self: flex-start;
}

.message-content {
    display: flex;
    gap: 10px;
    align-items: flex-start;
}

.message-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
}

.user-message .message-avatar {
    background: #667eea;
    color: white;
}

.bot-message .message-avatar {
    background: #f8f9fa;
    color: #333;
}

.message-text {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 15px;
    border-top-left-radius: 5px;
    line-height: 1.5;
}

.user-message .message-text {
    background: #667eea;
    color: white;
    border-radius: 15px;
    border-top-right-radius: 5px;
}

.message-text ul {
    margin: 10px 0;
    padding-left: 20px;
}

.message-text li {
    margin-bottom: 5px;
}

.message-time {
    font-size: 12px;
    color: #999;
    margin-top: 5px;
    align-self: flex-end;
}

.user-message .message-time {
    align-self: flex-start;
}

.chat-input-container {
    padding: 20px;
    border-top: 1px solid #e1e5e9;
    background: #f8f9fa;
}

.chat-input-wrapper {
    display: flex;
    gap: 10px;
    align-items: center;
}

#chat-input {
    flex: 1;
    padding: 15px;
    border: 2px solid #e1e5e9;
    border-radius: 25px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.3s ease;
}

#chat-input:focus {
    border-color: #667eea;
}

.send-button {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 15px 20px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.send-button:hover {
    background: #5a6fd8;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.send-button:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.typing-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    color: #666;
    font-size: 14px;
}

.typing-dots {
    display: flex;
    gap: 4px;
}

.typing-dots span {
    width: 8px;
    height: 8px;
    background: #667eea;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

@media (max-width: 768px) {
    .chatbot-main {
        grid-template-columns: 1fr;
        height: auto;
    }
    
    .chatbot-sidebar {
        order: 2;
    }
    
    .chatbot-chat {
        order: 1;
        height: 500px;
    }
}

/* Ensure navbar is always visible */
.navbar {
    position: relative !important;
    z-index: 1000 !important;
    background: var(--primary) !important;
    color: #fff !important;
    padding: 1rem 0 !important;
}

.nav-container {
    max-width: 1100px !important;
    margin: 0 auto !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    padding: 0 1rem !important;
}

.message-text ul li {
    margin-bottom: 10px;
    position: relative;
    padding-left: 28px;
    font-size: 1.08em;
    animation: fadeInUp 0.7s;
    transition: background 0.3s;
}
.message-text ul li::before {
    content: 'üìç';
    position: absolute;
    left: 0;
    top: 0;
    font-size: 1.1em;
    transition: transform 0.2s;
}
.message-text ul li:hover {
    background: #e6eaff;
}
.message-text p {
    animation: fadeInUp 0.7s;
    margin-bottom: 8px;
}
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const placeSelector = document.getElementById('place-selector');
    const quickQuestions = document.querySelectorAll('.quick-question');
    const typingIndicator = document.getElementById('typing-indicator');
    
    let sessionId = generateSessionId();
    let isTyping = false;
    
    function generateSessionId() {
        return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    function addMessage(message, isUser = false, timestamp = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
        const time = timestamp ? new Date(timestamp).toLocaleTimeString() : 'Just now';

        // Emoji mapping for common attractions
        const emojiMap = [
            { keyword: /botanical|garden/i, emoji: 'üå∫' },
            { keyword: /lake/i, emoji: 'üö£' },
            { keyword: /peak|mountain/i, emoji: '‚õ∞Ô∏è' },
            { keyword: /tea/i, emoji: 'üçµ' },
            { keyword: /rose/i, emoji: 'üåπ' },
            { keyword: /railway|train/i, emoji: 'üöÇ' },
            { keyword: /attraction/i, emoji: '‚≠ê' },
            { keyword: /picnic/i, emoji: 'üß∫' },
            { keyword: /view/i, emoji: 'üëÄ' },
            { keyword: /photograph/i, emoji: 'üì∏' },
        ];

        function addEmojis(text) {
            let t = text;
            emojiMap.forEach(({ keyword, emoji }) => {
                if (keyword.test(t)) {
                    t = emoji + ' ' + t;
                }
            });
            // Render Markdown bold (**text**) and italics (*text*)
            t = t.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            t = t.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            return t;
        }

        let messageHtml = '';
        if (typeof message === 'string') {
            const lines = message.split(/\r?\n/).map(line => line.trim()).filter(line => line);
            let inList = false;
            lines.forEach((line, idx) => {
                // Only treat lines starting with dash or number as list items
                if (/^(-|\d+\.)\s+/.test(line)) {
                    if (!inList) {
                        messageHtml += '<ul>';
                        inList = true;
                    }
                    // Remove the bullet/number and add as <li> with emoji
                    let cleanLine = line.replace(/^(-|\d+\.)\s+/, '');
                    cleanLine = addEmojis(cleanLine);
                    messageHtml += `<li>${cleanLine}</li>`;
                } else {
                    if (inList) {
                        messageHtml += '</ul>';
                        inList = false;
                    }
                    messageHtml += `<p>${addEmojis(line)}</p>`;
                }
            });
            if (inList) {
                messageHtml += '</ul>';
            }
        } else {
            messageHtml = `<p>${message}</p>`;
        }
        
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-avatar">${isUser ? 'üë§' : 'ü§ñ'}</div>
                <div class="message-text">
                    ${messageHtml}
                </div>
            </div>
            <div class="message-time">${time}</div>
        `;
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Restore sendMessage and event listeners
    function showTyping() {
        isTyping = true;
        typingIndicator.style.display = 'flex';
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function hideTyping() {
        isTyping = false;
        typingIndicator.style.display = 'none';
    }
    
    async function sendMessage(message) {
        if (!message.trim() || isTyping) return;
        
        // Add user message
        addMessage(message, true);
        
        // Clear input
        chatInput.value = '';
        
        // Show typing indicator
        showTyping();
        
        try {
            const response = await fetch('/api/chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    message: message,
                    place_id: placeSelector.value,
                    session_id: sessionId
                })
            });
            
            const data = await response.json();
            
            hideTyping();
            
            if (data.error) {
                addMessage('Sorry, I encountered an error. Please try again.');
            } else {
                addMessage(data.response, false, data.timestamp);
            }
        } catch (error) {
            hideTyping();
            addMessage('Sorry, I encountered an error. Please try again.');
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Event listeners
    sendButton.addEventListener('click', () => {
        sendMessage(chatInput.value);
    });
    
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage(chatInput.value);
        }
    });
    
    quickQuestions.forEach(question => {
        question.addEventListener('click', () => {
            const questionText = question.getAttribute('data-question');
            sendMessage(questionText);
        });
    });
    
    // Load chat history if session exists
    async function loadChatHistory() {
        try {
            const response = await fetch(`/api/chat/history/?session_id=${sessionId}`);
            const data = await response.json();
            
            if (data.messages && data.messages.length > 0) {
                chatMessages.innerHTML = '';
                data.messages.forEach(msg => {
                    addMessage(msg.message, msg.is_user, msg.timestamp);
                });
            }
        } catch (error) {
            console.error('Error loading chat history:', error);
        }
    }
    
    // Load chat history on page load
    loadChatHistory();
});
</script>
{% endblock %} 